INCLUDE_DIR     = @includedir@@versiondir@
PMC_INCLUDE_DIR = @includedir@@versiondir@/pmc
LIB_DIR         = @libdir@@versiondir@
SRC_DIR         = @srcdir@@versiondir@
TOOLS_DIR       = @libdir@@versiondir@/tools
INSTALL_DIR     = $(LIBDIR)/dynpmc

LOAD_EXT      = @load_ext@
O             = @o@
DUMP          = .dump

PERL          = @perl@
RM_F          = @rm_f@
CP            = @cp@
CAT           = @cat@
PARROT        = @bindir@/parrot@exe@
PBC_TO_EXE    = @bindir@/pbc_to_exe$(EXE)
PERL_LIB      = $(TOOLS_DIR)/lib
NQP           = $(PARROT) $(LIB_DIR)/languages/nqp/nqp.pbc
PBC_TO_EXE    = @bindir@/pbc_to_exe
CFLAGS        = -fPIC

LD            = @ld@
LD_LOAD_FLAGS = -shared -O2 -g -fPIC
LINKARGS      = $(LD_LOAD_FLAGS) -lblas

PARROT_DYNEXT = $(LIB_DIR)/dynext
PERL6GRAMMAR  = $(LIB_DIR)/library/PGE/Perl6Grammar.pbc
PCT           = $(LIB_DIR)/PCT.pbc
PMC2C         = $(PERL) $(TOOLS_DIR)/build/pmc2c.pl

GROUP         = linalg_group
PMC_DIR       = src/pmc
DYNPMC        = $(PMC_DIR)/$(GROUP)$(LOAD_EXT)
DYNEXT_DIR    = dynext
DYNEXT_TARGET = $(DYNEXT_DIR)/$(GROUP)$(LOAD_EXT)

PMC2C_INCLUDES = --include $(PMC_DIR) --include $(SRC_DIR) --include $(SRC_DIR)/pmc

PMC_SOURCES = \
    $(PMC_DIR)/nummatrix2d.pmc

all: $(DYNEXT_TARGET)

clean:
	$(RM_F) src/pmc/*$(O)
	$(RM_F) src/pmc/*$(DUMP)
	$(RM_F) src/pmc/*.c
	$(RM_F) src/pmc/pmc_*.h
	$(RM_F) src/pmc/$(GROUP)$(LOAD_EXT)
	$(RM_F) $(GROUP).*
	$(RM_F) dynext/*$(LOAD_EXT)

realclean: clean
	$(RM_F) Makefile


install: all
#IF(cygwin or hpux):    CHMOD 0775 linalg_group$(LOAD_EXT)
	$(CP) linalg_group$(LOAD_EXT) $(INSTALL_DIR)


uninstall:
	$(RM_F) $(INSTALL_DIR)/linalg_group$(LOAD_EXT)

$(DYNPMC): $(PMC_SOURCES)
	$(PMC2C) --no-lines --dump $(PMC2C_INCLUDES) $(PMC_SOURCES)
	$(PMC2C) --no-lines --c $(PMC2C_INCLUDES) $(PMC_SOURCES)
	$(PMC2C) --no-lines --library $(GROUP) --c $(PMC_SOURCES)
	$(CC) -c @cc_o_out@$(GROUP)$(O) -I$(PMC_DIR) -I$(INCLUDE_DIR) -I$(PMC_INCLUDE_DIR) $(CFLAGS) $(GROUP).c
	cd $(PMC_DIR) && $(CC) -c -I$(PMC_DIR) -I$(INCLUDE_DIR) -I$(PMC_INCLUDE_DIR) $(CFLAGS) *.c
	$(LD) @ld_out@$(DYNPMC) $(GROUP)$(O) src/pmc/*$(O) $(LINKARGS)

$(DYNEXT_TARGET): $(DYNPMC)
	$(CP) $(DYNPMC) $(DYNEXT_DIR)/

# This is a listing of all targets, that are meant to be called by users
help:
	@echo ""
	@echo "Following targets are available for the user:"
	@echo ""
	@echo "  all:               This is the default."
	@echo "Testing:"
	@echo "  test:              Run the test suite."
	@echo ""
	@echo "Cleaning:"
	@echo "  clean:             Basic cleaning up."
	@echo "  realclean:         Removes also files generated by 'Configure.pl'"
	@echo ""
	@echo "Installation:"
	@echo "  install:           Install the pmcs to Parrot's install dir"
	@echo "  uninstall:         Remove an existing installation"
	@echo "Misc:"
	@echo "  help:              Print this help message."
	@echo ""

# Local variables:
#   mode: makefile
# End:
# vim: ft=make:

